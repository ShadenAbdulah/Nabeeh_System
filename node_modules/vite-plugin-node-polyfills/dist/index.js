import { readFileSync as h } from "node:fs";
import { createRequire as B } from "node:module";
import y from "@rollup/plugin-inject";
import x from "node-stdlib-browser";
import { handleCircularDependancyWarning as P } from "node-stdlib-browser/helpers/rollup/plugin";
import O from "node-stdlib-browser/helpers/esbuild/plugin";
const c = (e) => e ? e === !0 ? !0 : e === "build" : !1, u = (e) => e ? e === !0 ? !0 : e === "dev" : !1, S = (e) => e.startsWith("node:"), $ = (e) => e.replace(/^node:/, ""), q = (e = {}) => {
  const f = B(import.meta.url), i = f.resolve("vite-plugin-node-polyfills/shims"), g = f.resolve("vite-plugin-node-polyfills/shims/banner"), a = h(g, "utf-8"), r = {
    include: [],
    exclude: [],
    overrides: {},
    protocolImports: !0,
    ...e,
    globals: {
      Buffer: !0,
      global: !0,
      process: !0,
      ...e.globals
    }
  }, d = (o, t) => o === t || o === `node:${t}`, m = (o) => r.include.length ? !r.include.some((t) => d(o, t)) : r.exclude.some((t) => d(o, t)), v = (o) => {
    if (u(r.globals.Buffer) && /^buffer$/.test(o))
      return f.resolve("buffer-polyfill");
    if (o in r.overrides)
      return r.overrides[o];
  };
  return {
    name: "vite-plugin-node-polyfills",
    config: (o, t) => {
      const n = t.command === "serve", b = Object.entries(x).reduce((l, [s, p]) => (!r.protocolImports && S(s) || m(s) || (l[s] = v($(s)) || p), l), {});
      return {
        build: {
          rollupOptions: {
            onwarn: (l, s) => {
              P(l, () => {
                if (o.build?.rollupOptions?.onwarn)
                  return o.build.rollupOptions.onwarn(l, s);
                s(l);
              });
            },
            plugins: [
              {
                ...y({
                  // https://github.com/niksy/node-stdlib-browser/blob/3e7cd7f3d115ac5c4593b550e7d8c4a82a0d4ac4/README.md#vite
                  ...c(r.globals.Buffer) ? { Buffer: [i, "Buffer"] } : {},
                  ...c(r.globals.global) ? { global: [i, "global"] } : {},
                  ...c(r.globals.process) ? { process: [i, "process"] } : {}
                })
              }
            ]
          }
        },
        esbuild: {
          // In dev, the global polyfills need to be injected as a banner in order for isolated scripts (such as Vue SFCs) to have access to them.
          banner: n ? a : void 0
        },
        optimizeDeps: {
          esbuildOptions: {
            banner: n ? { js: a } : void 0,
            // https://github.com/niksy/node-stdlib-browser/blob/3e7cd7f3d115ac5c4593b550e7d8c4a82a0d4ac4/README.md?plain=1#L203-L209
            define: {
              ...n && u(r.globals.Buffer) ? { Buffer: "Buffer" } : {},
              ...n && u(r.globals.global) ? { global: "global" } : {},
              ...n && u(r.globals.process) ? { process: "process" } : {}
            },
            inject: [
              i
            ],
            plugins: [
              O(b),
              // Supress the 'injected path "..." cannot be marked as external' error in Vite 4 (emitted by esbuild).
              // https://github.com/evanw/esbuild/blob/edede3c49ad6adddc6ea5b3c78c6ea7507e03020/internal/bundler/bundler.go#L1469
              {
                name: "vite-plugin-node-polyfills-shims-resolver",
                setup(l) {
                  const s = i.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), p = new RegExp(`^${s}$`);
                  l.onResolve({ filter: p }, () => ({
                    // https://github.com/evanw/esbuild/blob/edede3c49ad6adddc6ea5b3c78c6ea7507e03020/internal/bundler/bundler.go#L1468
                    external: !1,
                    path: i
                  }));
                }
              }
            ]
          }
        },
        resolve: {
          // https://github.com/niksy/node-stdlib-browser/blob/3e7cd7f3d115ac5c4593b550e7d8c4a82a0d4ac4/README.md?plain=1#L150
          alias: {
            ...b
          }
        }
      };
    }
  };
};
export {
  q as nodePolyfills
};
//# sourceMappingURL=index.js.map
